<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - APSZ Library</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <!-- Auth Check -->
    <script src="auth.js"></script>
    <script>
      checkAdmin();
      
      // Load issue books when page loads
      window.addEventListener('load', () => {
        loadIssuedBooks();
        loadDashboardStats();
        loadBooks();
        loadMembers();
        loadIssueFormOptions();
        loadReturnFormOptions();
        updateStatsAndUserInfo();
        setupFormHandlers();
      });

      // Setup form handlers
      function setupFormHandlers() {
        // Add Book Form
        const addBookForm = document.getElementById('add-book-form');
        if (addBookForm) {
          addBookForm.addEventListener('submit', handleAddBook);
        }

        // Add Member Form
        const addMemberForm = document.getElementById('add-member-form');
        if (addMemberForm) {
          addMemberForm.addEventListener('submit', handleAddMember);
        }
        
        // Issue Book Form
        const issueForm = document.getElementById('issue-book-form');
        if (issueForm) {
          issueForm.addEventListener('submit', handleIssueSubmit);
        }

        // Return Book Form
        const returnForm = document.getElementById('return-book-form');
        if (returnForm) {
          returnForm.addEventListener('submit', handleReturnSubmit);
        }
      }

      // Handle Add Book
      function handleAddBook(e) {
        e.preventDefault();
        const title = document.getElementById('book-title').value;
        const author = document.getElementById('book-author').value;
        const category = document.getElementById('book-category').value;
        const isbn = document.getElementById('book-isbn').value;

        fetch('http://localhost:5000/api/books/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title,
            author,
            category,
            isbn
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Book added successfully!');
            document.getElementById('add-book-form').reset();
            loadBooks();
            loadDashboardStats();
          } else {
            alert('Error: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error adding book');
        });
      }

      // Handle Add Member
      function handleAddMember(e) {
        e.preventDefault();
        const name = document.getElementById('member-name').value;
        const email = document.getElementById('member-email').value;
        const phone = document.getElementById('member-phone').value;
        const password = document.getElementById('member-password').value;

        fetch('http://localhost:5000/api/members/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name,
            email,
            phone,
            password
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Member added successfully!');
            document.getElementById('add-member-form').reset();
            loadMembers();
            loadDashboardStats();
          } else {
            alert('Error: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error adding member');
        });
      }

      // Load books
      function loadBooks() {
        fetch('http://localhost:5000/api/books/all')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.books && data.books.length > 0) {
              const tableBody = document.getElementById('books-table');
              tableBody.innerHTML = '';

              data.books.forEach(book => {
                const row = document.createElement('tr');
                const statusBadge = book.status && book.status.toLowerCase() === 'issued' ? `<span class="badge issued">Issued</span>` : `<span class="badge available">Available</span>`;
                row.innerHTML = `
                  <td>${book.title}</td>
                  <td>${book.author}</td>
                  <td>${book.category}</td>
                  <td>${book.isbn || 'N/A'}</td>
                  <td>${statusBadge}</td>
                  <td><button class="btn-small btn-delete" onclick="deleteBook(${book.id})">Delete</button></td>
                `;
                tableBody.appendChild(row);
              });
            } else {
              const tableBody = document.getElementById('books-table');
              tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No books added yet</td></tr>';
            }
          })
          .catch(error => {
            console.error('Error loading books:', error);
          });
      }

      // Load options for Issue Book form (books + members)
      function loadIssueFormOptions() {
        // Load available books
        fetch('http://localhost:5000/api/books/all')
          .then(res => res.json())
          .then(data => {
            const bookSelect = document.getElementById('issue-book-select');
            if (!bookSelect) return;
            bookSelect.innerHTML = '<option value="">Select Book</option>';
            if (data.success && data.books) {
              data.books.forEach(book => {
                // include only books not issued
                const status = (book.status || '').toLowerCase();
                if (status !== 'issued') {
                  const opt = document.createElement('option');
                  opt.value = book.id;
                  opt.textContent = `${book.title} - ${book.author}`;
                  opt.setAttribute('data-title', book.title);
                  bookSelect.appendChild(opt);
                }
              });
            }
          })
          .catch(err => console.error('Error loading books for issue form:', err));

        // Load members
        fetch('http://localhost:5000/api/members/all')
          .then(res => res.json())
          .then(data => {
            const memSelect = document.getElementById('issue-member-select');
            if (!memSelect) return;
            memSelect.innerHTML = '<option value="">Select Member</option>';
            if (data.success && data.members) {
              data.members.forEach(member => {
                const opt = document.createElement('option');
                opt.value = member.id;
                opt.textContent = `${member.name} (${member.email})`;
                memSelect.appendChild(opt);
              });
            }
          })
          .catch(err => console.error('Error loading members for issue form:', err));
      }

      // Handle Issue Book form submit
      function handleIssueSubmit(e) {
        e.preventDefault();
        const bookSelect = document.getElementById('issue-book-select');
        const memSelect = document.getElementById('issue-member-select');
        const issueDate = document.getElementById('issue-date').value;
        const returnDate = document.getElementById('issue-return-date').value;

        if (!bookSelect || !memSelect) return alert('Issue form not initialized');

        const bookId = bookSelect.value;
        const bookTitle = bookSelect.options[bookSelect.selectedIndex]?.getAttribute('data-title') || '';
        const memberId = memSelect.value;

        if (!bookId || !memberId || !issueDate || !returnDate) {
          return alert('Please select book, member and fill dates');
        }

        fetch('http://localhost:5000/api/borrow/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: memberId,
            book_id: bookId,
            book_title: bookTitle,
            issue_date: issueDate,
            return_date: returnDate
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('Book issued successfully');
            document.getElementById('issue-book-form').reset();
            loadIssuedBooks();
            loadBooks();
            loadIssueFormOptions();
            loadDashboardStats();
          } else {
            alert('Error issuing book: ' + (data.message || 'unknown'));
          }
        })
        .catch(err => {
          console.error('Error issuing book:', err);
          alert('Error issuing book');
        });
      }

      // Delete book
      function deleteBook(bookId) {
        if (confirm('Are you sure you want to delete this book?')) {
          fetch(`http://localhost:5000/api/books/${bookId}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Book deleted successfully!');
              loadBooks();
              loadDashboardStats();
            } else {
              alert('Error: ' + data.message);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error deleting book');
          });
        }
      }

      // Load members list
      function loadMembers() {
        fetch('http://localhost:5000/api/members/all')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.members && data.members.length > 0) {
              const tableBody = document.getElementById('members-table');
              tableBody.innerHTML = '';

              data.members.forEach(member => {
                const joinedDate = new Date(member.created_at).toLocaleDateString();
                const row = document.createElement('tr');
                row.innerHTML = `
                  <td>${member.name}</td>
                  <td>${member.email}</td>
                  <td>${member.phone || 'N/A'}</td>
                  <td>${joinedDate}</td>
                  <td><button class="btn-small btn-delete" onclick="deleteMember(${member.id})">Delete</button></td>
                `;
                tableBody.appendChild(row);
              });
            } else {
              const tableBody = document.getElementById('members-table');
              tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No members found</td></tr>';
            }
          })
          .catch(error => {
            console.error('Error loading members:', error);
          });
      }

      // Delete member
      function deleteMember(memberId) {
        if (confirm('Are you sure you want to delete this member?')) {
          fetch(`http://localhost:5000/api/members/${memberId}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Member deleted successfully!');
              loadMembers();
              loadDashboardStats();
            } else {
              alert('Error: ' + data.message);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error deleting member');
          });
        }
      }

      // Load dashboard stats from database
      function loadDashboardStats() {
        fetch('http://localhost:5000/api/borrow/stats/dashboard')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.stats) {
              const stats = data.stats;
              
              // Update stat cards
              const statCards = document.querySelectorAll('.stat-card');
              if (statCards[0]) {
                statCards[0].querySelector('.stat-number').textContent = stats.totalBooks || 0;
              }
              if (statCards[1]) {
                statCards[1].querySelector('.stat-number').textContent = stats.totalMembers || 0;
              }
              if (statCards[2]) {
                statCards[2].querySelector('.stat-number').textContent = stats.booksIssued || 0;
              }
              if (statCards[3]) {
                statCards[3].querySelector('.stat-number').textContent = stats.overdueBooks || 0;
              }
            }
          })
          .catch(error => {
            console.error('Error loading dashboard stats:', error);
          });
      }

        // Load options for Return Book form (active borrows)
        function loadReturnFormOptions() {
          fetch('http://localhost:5000/api/borrow/all')
            .then(res => res.json())
            .then(data => {
              const sel = document.getElementById('return-book-select');
              if (!sel) return;
              sel.innerHTML = '<option value="">Select Issued Book</option>';
              if (data.success && data.records) {
                data.records.forEach(rec => {
                  if (rec.status && rec.status.toLowerCase() === 'active') {
                    const opt = document.createElement('option');
                    opt.value = rec.id;
                    opt.textContent = `${rec.book_title} - ${rec.username || 'N/A'} (Due: ${new Date(rec.return_date).toLocaleDateString()})`;
                    sel.appendChild(opt);
                  }
                });
              }
            })
            .catch(err => console.error('Error loading return form options:', err));
        }

        // Handle Return Book form submit
        function handleReturnSubmit(e) {
          e.preventDefault();
          const sel = document.getElementById('return-book-select');
          const dateInput = document.getElementById('return-date');
          if (!sel || !dateInput) return alert('Return form not initialized');
          const borrowId = sel.value;
          const actualReturnDate = dateInput.value;
          if (!borrowId || !actualReturnDate) return alert('Please select issued book and return date');

          fetch('http://localhost:5000/api/borrow/return', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ borrowId, actualReturnDate })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert('Return processed successfully');
              document.getElementById('return-book-form').reset();
              loadIssuedBooks();
              loadBooks();
              loadIssueFormOptions();
              loadReturnFormOptions();
              loadDashboardStats();
            } else {
              alert('Error processing return: ' + (data.message || 'unknown'));
            }
          })
          .catch(err => {
            console.error('Error processing return:', err);
            alert('Error processing return');
          });
        }

      // Load issued books from database
      function loadIssuedBooks() {
        fetch('http://localhost:5000/api/borrow/all')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.records && data.records.length > 0) {
              const tableBody = document.getElementById('issued-books-table');
              tableBody.innerHTML = '';

              data.records.forEach(record => {
                const returnDate = new Date(record.return_date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const daysLeft = Math.ceil((returnDate - today) / (1000 * 60 * 60 * 24));
                let statusBadge = '';
                
                if (daysLeft > 0) {
                  statusBadge = `<span class="badge available">Active</span>`;
                } else if (daysLeft === 0) {
                  statusBadge = `<span class="badge overdue">Due Today</span>`;
                } else {
                  statusBadge = `<span class="badge overdue">Overdue</span>`;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                  <td>${record.book_title}</td>
                  <td>${record.username || 'N/A'}</td>
                  <td>${record.email || 'N/A'}</td>
                  <td>${new Date(record.issue_date).toLocaleDateString()}</td>
                  <td>${new Date(record.return_date).toLocaleDateString()}</td>
                  <td>${statusBadge}</td>
                  <td>${Math.max(0, daysLeft)} days</td>
                `;
                tableBody.appendChild(row);
              });
            } else {
              const tableBody = document.getElementById('issued-books-table');
              tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No issued books yet</td></tr>';
            }
          })
          .catch(error => {
            console.error('Error loading issued books:', error);
            const tableBody = document.getElementById('issued-books-table');
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">Error loading issued books</td></tr>';
          });
      }

      // Update user info and stats
      function updateStatsAndUserInfo() {
        const user = getCurrentUser();
        if (user) {
          document.getElementById('user-name').textContent = user.username || user.email;
          document.getElementById('user-role').textContent = '(' + (user.role || 'user') + ')';
        }
      }
    </script>

    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-logo">
                <img src="imgs/logo.png" alt="APSZ Logo" id="logo">
                <h1>APSZ Admin Panel</h1>
            </div>
            <input type="checkbox" id="check">
            <label for="check" class="checkBtn">
                <i class="fas fa-bars"></i>
            </label>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="admin.html" class="nav-link active">Admin</a></li>
                <li><a href="#" class="nav-link">Reports</a></li>
                <li><a href="#" class="nav-link nav-link-btn" onclick="handleLogout()">Logout</a></li>
            </ul>
            <div class="navbar-user" style="margin-right: 20px;">
                <span id="user-name" style="font-weight: 500; margin-right: 5px;"></span>
                <span id="user-role" style="font-size: 0.9em; color: #666;"></span>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Dashboard Stats -->
        <section class="stats-section">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stat-content">
                    <p class="stat-label">Total Books</p>
                    <h2 class="stat-number">0</h2>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <p class="stat-label">Total Members</p>
                    <h2 class="stat-number">0</h2>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-share-alt"></i>
                </div>
                <div class="stat-content">
                    <p class="stat-label">Books Issued</p>
                    <h2 class="stat-number">0</h2>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <p class="stat-label">Overdue Books</p>
                    <h2 class="stat-number">0</h2>
                </div>
            </div>
        </section>

        <!-- Add Book Section -->
        <section class="card">
            <div class="card-header">
                <h2>Add New Book</h2>
                <p>Enter book details to add to the library</p>
            </div>
            <form class="form-grid" id="add-book-form">
                <input type="text" id="book-title" placeholder="Book Title" required>
                <input type="text" id="book-author" placeholder="Author Name" required>
                <input type="text" id="book-category" placeholder="Category" required>
                <input type="text" id="book-isbn" placeholder="ISBN" required>
                <button type="submit" class="btn-primary">Add Book</button>
            </form>
        </section>

        <!-- Add Member Section -->
        <section class="card">
            <div class="card-header">
                <h2>Add New Member</h2>
                <p>Register a new member to the library</p>
            </div>
            <form class="form-grid" id="add-member-form">
                <input type="text" id="member-name" placeholder="Member Name" required>
                <input type="email" id="member-email" placeholder="Email Address" required>
                <input type="tel" id="member-phone" placeholder="Phone Number" required>
                <input type="password" id="member-password" placeholder="Password (optional)">
                <button type="submit" class="btn-primary">Add Member</button>
            </form>
        </section>

        <!-- Issue Book Section -->
        <section class="card">
            <div class="card-header">
                <h2>Issue Book</h2>
                <p>Issue a book to a member</p>
            </div>
            <form class="form-grid" id="issue-book-form">
              <select id="issue-book-select" required>
                <option value="">Select Book</option>
              </select>
              <select id="issue-member-select" required>
                <option value="">Select Member</option>
              </select>
              <input type="date" id="issue-date" required>
              <input type="date" id="issue-return-date" placeholder="Due Date" required>
              <button type="submit" class="btn-primary">Issue Book</button>
            </form>
        </section>

        <!-- Return Book Section -->
        <section class="card">
            <div class="card-header">
                <h2>Return Book</h2>
                <p>Process book return from member</p>
            </div>
          <form class="form-grid" id="return-book-form">
            <select id="return-book-select" required>
              <option value="">Select Issued Book</option>
            </select>
            <input type="date" id="return-date" required>
            <button type="submit" class="btn-primary">Process Return</button>
          </form>
        </section>

        <!-- Recent Books Table -->
        <section class="card">
            <div class="card-header">
                <h2>Issued Books</h2>
                <p>All books currently borrowed by members</p>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Book Title</th>
                            <th>Member Name</th>
                            <th>Email</th>
                            <th>Issue Date</th>
                            <th>Return Date</th>
                            <th>Status</th>
                            <th>Days Left</th>
                        </tr>
                    </thead>
                    <tbody id="issued-books-table">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem;">Loading issued books...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Books Table -->
        <section class="card">
            <div class="card-header">
                <h2>All Books</h2>
                <p>Complete list of books in the library</p>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Book Title</th>
                            <th>Author</th>
                            <th>Category</th>
                            <th>ISBN</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="books-table">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem;">Loading books...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Members Table -->
        <section class="card">
            <div class="card-header">
                <h2>Library Members</h2>
                <p>All registered members of the library</p>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Member Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Joined Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="members-table">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem;">Loading members...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>
</body>
</html>
